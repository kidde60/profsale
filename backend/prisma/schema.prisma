generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model businesses {
  id                  Int                   @id @default(autoincrement())
  owner_id            Int
  business_name       String                @db.VarChar(255)
  business_type       String?               @db.VarChar(100)
  description         String?               @db.Text
  phone               String?               @db.VarChar(15)
  email               String?               @db.VarChar(255)
  address             String?               @db.Text
  currency            String?               @default("UGX") @db.VarChar(3)
  timezone            String?               @default("Africa/Kampala") @db.VarChar(50)
  logo_url            String?               @db.VarChar(255)
  is_active           Boolean?              @default(true)
  created_at          DateTime              @default(now()) @db.Timestamp(0)
  updated_at          DateTime              @default(now()) @db.Timestamp(0)
  users               users                 @relation(fields: [owner_id], references: [id], onUpdate: Restrict, map: "businesses_ibfk_1")
  categories          categories[]
  customers           customers[]
  employees           employees[]
  expenses            expenses[]
  inventory_movements inventory_movements[]
  products            products[]
  sales               sales[]
  subscriptions       subscriptions[]
  sync_logs           sync_logs[]
  system_settings     system_settings[]

  @@index([is_active], map: "idx_active")
  @@index([owner_id], map: "idx_owner")
}

model categories {
  id               Int          @id @default(autoincrement())
  business_id      Int?
  name             String       @db.VarChar(100)
  description      String?      @db.Text
  parent_id        Int?
  is_template      Boolean?     @default(false)
  is_active        Boolean?     @default(true)
  created_at       DateTime     @default(now()) @db.Timestamp(0)
  updated_at       DateTime     @default(now()) @db.Timestamp(0)
  businesses       businesses?  @relation(fields: [business_id], references: [id], onDelete: Cascade, onUpdate: Restrict, map: "categories_ibfk_1")
  categories       categories?  @relation("categoriesTocategories", fields: [parent_id], references: [id], onUpdate: Restrict, map: "categories_ibfk_2")
  other_categories categories[] @relation("categoriesTocategories")
  products         products[]

  @@index([is_active], map: "idx_active")
  @@index([business_id], map: "idx_business")
  @@index([parent_id], map: "idx_parent")
  @@index([is_template], map: "idx_template")
}

model customers {
  id                 Int                      @id @default(autoincrement())
  business_id        Int
  name               String                   @db.VarChar(255)
  phone              String?                  @db.VarChar(15)
  email              String?                  @db.VarChar(255)
  address            String?                  @db.Text
  total_purchases    Decimal?                 @default(0.00) @db.Decimal(12, 2)
  total_orders       Int?                     @default(0)
  loyalty_points     Int?                     @default(0)
  customer_type      customers_customer_type? @default(regular)
  last_purchase_date DateTime?                @db.Date
  created_at         DateTime                 @default(now()) @db.Timestamp(0)
  updated_at         DateTime                 @default(now()) @db.Timestamp(0)
  businesses         businesses               @relation(fields: [business_id], references: [id], onDelete: Cascade, onUpdate: Restrict, map: "customers_ibfk_1")
  sales              sales[]

  @@index([business_id], map: "idx_business")
  @@index([email], map: "idx_email")
  @@index([phone], map: "idx_phone")
  @@index([customer_type], map: "idx_type")
}

model employees {
  id          Int            @id @default(autoincrement())
  business_id Int
  user_id     Int
  role        employees_role @default(employee)
  permissions String?        @db.LongText
  is_active   Boolean?       @default(true)
  joined_at   DateTime       @default(now()) @db.Timestamp(0)
  businesses  businesses     @relation(fields: [business_id], references: [id], onDelete: Cascade, onUpdate: Restrict, map: "employees_ibfk_1")
  users       users          @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: Restrict, map: "employees_ibfk_2")

  @@unique([business_id, user_id], map: "unique_business_user")
  @@index([business_id], map: "idx_business")
  @@index([role], map: "idx_role")
  @@index([user_id], map: "idx_user")
}

model expenses {
  id                Int                      @id @default(autoincrement())
  business_id       Int
  recorded_by       Int
  description       String                   @db.VarChar(255)
  amount            Decimal                  @db.Decimal(12, 2)
  category          String                   @db.VarChar(100)
  expense_date      DateTime                 @db.Date
  payment_method    expenses_payment_method? @default(cash)
  payment_reference String?                  @db.VarChar(100)
  receipt_image     String?                  @db.VarChar(255)
  created_at        DateTime                 @default(now()) @db.Timestamp(0)
  updated_at        DateTime                 @default(now()) @db.Timestamp(0)
  businesses        businesses               @relation(fields: [business_id], references: [id], onDelete: Cascade, onUpdate: Restrict, map: "expenses_ibfk_1")
  users             users                    @relation(fields: [recorded_by], references: [id], onUpdate: Restrict, map: "expenses_ibfk_2")

  @@index([business_id], map: "idx_business")
  @@index([category], map: "idx_category")
  @@index([expense_date], map: "idx_date")
  @@index([payment_method], map: "idx_payment_method")
  @@index([recorded_by], map: "recorded_by")
}

model inventory_movements {
  id              Int                               @id @default(autoincrement())
  business_id     Int
  product_id      Int
  movement_type   inventory_movements_movement_type
  quantity_change Int
  reference_id    Int?
  reference_type  String?                           @db.VarChar(50)
  notes           String?                           @db.Text
  recorded_by     Int
  movement_date   DateTime                          @default(now()) @db.Timestamp(0)
  businesses      businesses                        @relation(fields: [business_id], references: [id], onDelete: Cascade, onUpdate: Restrict, map: "inventory_movements_ibfk_1")
  products        products                          @relation(fields: [product_id], references: [id], onDelete: Cascade, onUpdate: Restrict, map: "inventory_movements_ibfk_2")
  users           users                             @relation(fields: [recorded_by], references: [id], onUpdate: Restrict, map: "inventory_movements_ibfk_3")

  @@index([business_id], map: "idx_business")
  @@index([movement_date], map: "idx_date")
  @@index([product_id], map: "idx_product")
  @@index([movement_type], map: "idx_type")
  @@index([recorded_by], map: "recorded_by")
}

model otp_verifications {
  id              Int      @id @default(autoincrement())
  phone           String   @db.VarChar(15)
  otp_code        String   @db.VarChar(6)
  verification_id String   @unique(map: "verification_id") @db.VarChar(50)
  is_verified     Boolean? @default(false)
  expires_at      DateTime @default(now()) @db.Timestamp(0)
  created_at      DateTime @default(now()) @db.Timestamp(0)

  @@index([expires_at], map: "idx_expires")
  @@index([phone], map: "idx_phone")
  @@index([verification_id], map: "idx_verification_id")
}

model products {
  id                  Int                   @id @default(autoincrement())
  business_id         Int
  category_id         Int?
  name                String                @db.VarChar(255)
  description         String?               @db.Text
  barcode             String?               @db.VarChar(100)
  buying_price        Decimal               @db.Decimal(12, 2)
  selling_price       Decimal               @db.Decimal(12, 2)
  current_stock       Int?                  @default(0)
  min_stock_level     Int?                  @default(5)
  unit                String?               @default("pieces") @db.VarChar(20)
  product_image       String?               @db.VarChar(255)
  is_active           Boolean?              @default(true)
  created_by          Int
  created_at          DateTime              @default(now()) @db.Timestamp(0)
  updated_at          DateTime              @default(now()) @db.Timestamp(0)
  inventory_movements inventory_movements[]
  businesses          businesses            @relation(fields: [business_id], references: [id], onDelete: Cascade, onUpdate: Restrict, map: "products_ibfk_1")
  categories          categories?           @relation(fields: [category_id], references: [id], onUpdate: Restrict, map: "products_ibfk_2")
  users               users                 @relation(fields: [created_by], references: [id], onUpdate: Restrict, map: "products_ibfk_3")
  sale_items          sale_items[]

  @@index([created_by], map: "created_by")
  @@index([is_active], map: "idx_active")
  @@index([barcode], map: "idx_barcode")
  @@index([business_id], map: "idx_business")
  @@index([category_id], map: "idx_category")
  @@index([current_stock, min_stock_level], map: "idx_stock_alert")
  @@fulltext([name, description], map: "idx_search")
}

model sale_items {
  id            Int      @id @default(autoincrement())
  sale_id       Int
  product_id    Int
  product_name  String   @db.VarChar(255)
  quantity      Int
  unit_price    Decimal  @db.Decimal(12, 2)
  total_price   Decimal  @db.Decimal(12, 2)
  cost_price    Decimal  @db.Decimal(12, 2)
  profit_amount Decimal? @db.Decimal(12, 2)
  sales         sales    @relation(fields: [sale_id], references: [id], onDelete: Cascade, onUpdate: Restrict, map: "sale_items_ibfk_1")
  products      products @relation(fields: [product_id], references: [id], onUpdate: Restrict, map: "sale_items_ibfk_2")

  @@index([product_id], map: "idx_product")
  @@index([sale_id], map: "idx_sale")
}

model sales {
  id                Int                  @id @default(autoincrement())
  business_id       Int
  employee_id       Int
  customer_id       Int?
  sale_number       String               @unique(map: "sale_number") @db.VarChar(50)
  subtotal          Decimal              @db.Decimal(12, 2)
  tax_amount        Decimal?             @default(0.00) @db.Decimal(12, 2)
  discount_amount   Decimal?             @default(0.00) @db.Decimal(12, 2)
  total_amount      Decimal              @db.Decimal(12, 2)
  payment_method    sales_payment_method @default(cash)
  payment_reference String?              @db.VarChar(100)
  status            sales_status?        @default(completed)
  notes             String?              @db.Text
  sale_date         DateTime             @default(now()) @db.Timestamp(0)
  created_at        DateTime             @default(now()) @db.Timestamp(0)
  updated_at        DateTime             @default(now()) @db.Timestamp(0)
  sale_items        sale_items[]
  businesses        businesses           @relation(fields: [business_id], references: [id], onUpdate: Restrict, map: "sales_ibfk_1")
  users             users                @relation(fields: [employee_id], references: [id], onUpdate: Restrict, map: "sales_ibfk_2")
  customers         customers?           @relation(fields: [customer_id], references: [id], onUpdate: Restrict, map: "sales_ibfk_3")

  @@index([business_id], map: "idx_business")
  @@index([customer_id], map: "idx_customer")
  @@index([sale_date], map: "idx_date")
  @@index([employee_id], map: "idx_employee")
  @@index([payment_method], map: "idx_payment_method")
  @@index([status], map: "idx_status")
}

model subscriptions {
  id                Int                  @id @default(autoincrement())
  business_id       Int
  plan_id           String               @db.VarChar(50)
  status            subscriptions_status @default(active)
  start_date        DateTime             @db.Date
  end_date          DateTime             @db.Date
  amount            Decimal              @db.Decimal(12, 2)
  currency          String?              @default("UGX") @db.VarChar(3)
  payment_method    String?              @db.VarChar(50)
  payment_reference String?              @db.VarChar(100)
  auto_renew        Boolean?             @default(true)
  created_at        DateTime             @default(now()) @db.Timestamp(0)
  updated_at        DateTime             @default(now()) @db.Timestamp(0)
  businesses        businesses           @relation(fields: [business_id], references: [id], onDelete: Cascade, onUpdate: Restrict, map: "subscriptions_ibfk_1")

  @@index([business_id], map: "idx_business")
  @@index([end_date], map: "idx_end_date")
  @@index([status], map: "idx_status")
}

model sync_logs {
  id          Int                 @id @default(autoincrement())
  user_id     Int
  business_id Int
  table_name  String              @db.VarChar(50)
  operation   sync_logs_operation
  record_id   Int
  data        String?             @db.LongText
  synced      Boolean?            @default(false)
  created_at  DateTime            @default(now()) @db.Timestamp(0)
  synced_at   DateTime?           @db.Timestamp(0)
  users       users               @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: Restrict, map: "sync_logs_ibfk_1")
  businesses  businesses          @relation(fields: [business_id], references: [id], onDelete: Cascade, onUpdate: Restrict, map: "sync_logs_ibfk_2")

  @@index([business_id], map: "idx_business")
  @@index([synced], map: "idx_synced")
  @@index([table_name], map: "idx_table")
  @@index([user_id], map: "idx_user")
}

model system_settings {
  id            Int                        @id @default(autoincrement())
  business_id   Int
  setting_key   String                     @db.VarChar(100)
  setting_value String?                    @db.Text
  data_type     system_settings_data_type? @default(string)
  updated_by    Int
  updated_at    DateTime                   @default(now()) @db.Timestamp(0)
  businesses    businesses                 @relation(fields: [business_id], references: [id], onDelete: Cascade, onUpdate: Restrict, map: "system_settings_ibfk_1")
  users         users                      @relation(fields: [updated_by], references: [id], onUpdate: Restrict, map: "system_settings_ibfk_2")

  @@unique([business_id, setting_key], map: "unique_business_setting")
  @@index([business_id], map: "idx_business")
  @@index([updated_by], map: "updated_by")
}

model users {
  id                  Int                   @id @default(autoincrement())
  phone               String                @unique(map: "phone") @db.VarChar(15)
  email               String?               @db.VarChar(255)
  first_name          String                @db.VarChar(100)
  last_name           String                @db.VarChar(100)
  password_hash       String                @db.VarChar(255)
  profile_image       String?               @db.VarChar(255)
  is_verified         Boolean?              @default(false)
  is_active           Boolean?              @default(true)
  created_at          DateTime              @default(now()) @db.Timestamp(0)
  updated_at          DateTime              @default(now()) @db.Timestamp(0)
  businesses          businesses[]
  employees           employees[]
  expenses            expenses[]
  inventory_movements inventory_movements[]
  products            products[]
  sales               sales[]
  sync_logs           sync_logs[]
  system_settings     system_settings[]

  @@index([is_active], map: "idx_active")
  @@index([email], map: "idx_email")
  @@index([phone], map: "idx_phone")
}

enum employees_role {
  owner
  manager
  employee
}

enum inventory_movements_movement_type {
  purchase
  sale
  adjustment
  transfer
  return
}

enum subscriptions_status {
  active
  cancelled
  expired
  suspended
}

enum sync_logs_operation {
  INSERT
  UPDATE
  DELETE
}

enum system_settings_data_type {
  string
  number
  boolean
  json
}

enum expenses_payment_method {
  cash
  mobile_money
  bank_transfer
  cheque
}

enum customers_customer_type {
  regular
  vip
  wholesale
}

enum sales_payment_method {
  cash
  mobile_money
  bank_transfer
  credit
}

enum sales_status {
  pending
  completed
  cancelled
  refunded
}
